(ns middleware.compiler-test
  (:refer-clojure :exclude [compile])
  (:require [clojure.test :refer :all]
            [middleware.compiler.utils.ast :as ast-utils]
            [middleware.compiler.compiler :as cc])
  (:use [middleware.test-utils]))

(defn compile [ast]
  (register-program! ast)
  (:compiled (cc/compile-tree ast "")))

(deftest empty-program-test
  (let [ast {:__class__ "UziProgramNode",
             :scripts [{:__class__ "UziTaskNode",
                        :name "empty",
                        :arguments [],
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :value 1,
                                      :scale "s"},
                        :body {:__class__ "UziBlockNode",
                               :statements []}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [],
                             :locals [],
                             :name "empty",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-global-variable-test
  (let [ast {:__class__ "UziProgramNode",
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "counter"}],
             :scripts [{:__class__ "UziTaskNode",
                        :name "empty",
                        :arguments [],
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :value 1,
                                      :scale "s"},
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "counter"},
                                             :right {:__class__ "UziCallNode",
                                                     :selector "+",
                                                     :arguments [{:__class__ "Association",
                                                                  :value {:__class__ "UziVariableNode",
                                                                          :name "counter"}},
                                                                 {:__class__ "Association",
                                                                  :value {:__class__ "UziNumberLiteralNode",
                                                                          :value 1}}]}}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "counter",
                                                        ;:value 0
                                                        }},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        ;:code 6,
                                                        :name "add",
                                                        ;:stackTransition {:__class__ "Association",
                                                        ;                  :key 2,
                                                        ;                  :value 1}
                                                        }},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "counter",
                                                        ;:value 0
                                                        }}],
                             :locals [],
                             :name "empty",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :name "counter",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest task-without-ticking-rate
  (let [ast {:__class__ "UziProgramNode",
             :scripts [{:__class__ "UziTaskNode",,
                        :name "foo",
                        :arguments [],
                        :state "running",
                        :body {:__class__ "UziBlockNode",
                               :statements []}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [],
                             :locals [],
                             :name "foo",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                               :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest task-with-once
  (let [ast {:__class__ "UziProgramNode",
             :scripts [{:__class__ "UziTaskNode",,
                        :name "foo",
                        :arguments [],
                        :state "once",
                        :body {:__class__ "UziBlockNode",
                               :statements []}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziStopScriptInstruction",
                                             :argument "foo"}],
                             :locals [],
                             :name "foo",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest program-with-local-variable
  (let [ast {:__class__ "UziProgramNode",
             :scripts [{:__class__ "UziTaskNode",
                        :name "foo",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziVariableDeclarationNode",
                                             :name "pin",
                                             :value {:__class__ "UziCallNode"
                                                     :selector "+"
                                                     :arguments [{:__class__ "Association",
                                                                  :value {:__class__ "UziNumberLiteralNode",
                                                                          :value 1}}
                                                                 {:__class__ "Association"
                                                                  :value {:__class__ "UziPinLiteralNode",
                                                                          :type "D",
                                                                          :number 13}}]}},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "pin"}}]}]}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :name "foo",
                             :running? true,
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :locals [{:__class__ "UziVariable",
                                       :name "pin#1",
                                       :value 0}],
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "pin#1",}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "pin#1"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "foo"}]}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 1},
                               {:__class__ "UziVariable", :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest ast-transform-test
  (let [original {:__class__ "UziProgramNode",
                  :scripts [{:__class__ "UziTaskNode",
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :statements [{:__class__ "UziCallNode",
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 12}}]}]}}]}
        expected {:__class__ "UziProgramNode",
                  :__foo__ 1,
                  :scripts [{:__class__ "UziTaskNode",
                             :__foo__ 2,
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :__bar__ 5,
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :__bar__ 5,
                                    :statements [{:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :__bar__ 5,
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :__bar__ 5,
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4,
                                                                       :value 12}}]}]}}]}
        actual (ast-utils/transform
                original
                "UziProgramNode" (fn [node _] (assoc node :__foo__ 1))
                "UziTaskNode" (fn [node _] (assoc node :__foo__ 2))
                "UziCallNode" (fn [node _] (assoc node :__foo__ 3))
                "UziNumberLiteralNode" (fn [node _] (assoc node :__foo__ 4))
                :default (fn [node _] (assoc node :__bar__ 5)))]
    (is (= expected actual))))

(deftest ast-transform-without-default-clause
  (let [original {:__class__ "UziProgramNode",
                  :scripts [{:__class__ "UziTaskNode",
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :statements [{:__class__ "UziCallNode",
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 12}}]}]}}]}
        expected {:__class__ "UziProgramNode",
                  :__foo__ 1,
                  :scripts [{:__class__ "UziTaskNode",
                             :__foo__ 2,
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :statements [{:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4,
                                                                       :value 12}}]}]}}]}
        actual (ast-utils/transform
                original
                "UziProgramNode" (fn [node _] (assoc node :__foo__ 1))
                "UziTaskNode" (fn [node _] (assoc node :__foo__ 2))
                "UziCallNode" (fn [node _] (assoc node :__foo__ 3))
                "UziNumberLiteralNode" (fn [node _] (assoc node :__foo__ 4)))]
    (is (= expected actual))))

(deftest ast-transform-pred-test
  (let [original {:__class__ "UziProgramNode",
                  :scripts [{:__class__ "UziTaskNode",
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :statements [{:__class__ "UziCallNode",
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 12}}]}]}}]}
        expected {:__class__ "UziProgramNode",
                  :__foo__ 1,
                  :scripts [{:__class__ "UziTaskNode",
                             :__foo__ 2,
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :__bar__ 5,
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :__bar__ 5,
                                    :statements [{:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :__bar__ 5,
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :__bar__ 5,
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4,
                                                                       :value 12}}]}]}}]}
        actual (ast-utils/transformp
                original
                (fn [node _] (= "UziProgramNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 1))
                (fn [node _] (= "UziTaskNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 2))
                (fn [node _] (= "UziCallNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 3))
                (fn [node _] (= "UziNumberLiteralNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 4))
                :default (fn [node _] (assoc node :__bar__ 5)))]
    (is (= expected actual))))

(deftest ast-transform-pred-without-default-clause
  (let [original {:__class__ "UziProgramNode",
                  :scripts [{:__class__ "UziTaskNode",
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :statements [{:__class__ "UziCallNode",
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :value 12}}]}]}}]}
        expected {:__class__ "UziProgramNode",
                  :__foo__ 1,
                  :scripts [{:__class__ "UziTaskNode",
                             :__foo__ 2,
                             :name "empty",
                             :arguments [],
                             :state "running",
                             :tickingRate {:__class__ "UziTickingRateNode",
                                           :value 1,
                                           :scale "s"},
                             :body {:__class__ "UziBlockNode",
                                    :statements [{:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "toggle",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4
                                                                       :value 13}}]},
                                                 {:__class__ "UziCallNode",
                                                  :__foo__ 3,
                                                  :selector "turnOn",
                                                  :arguments [{:__class__ "Association",
                                                               :key nil,
                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                       :__foo__ 4,
                                                                       :value 12}}]}]}}]}
        actual (ast-utils/transformp
                original
                (fn [node _] (= "UziProgramNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 1))
                (fn [node _] (= "UziTaskNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 2))
                (fn [node _] (= "UziCallNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 3))
                (fn [node _] (= "UziNumberLiteralNode" (get node :__class__))) (fn [node _] (assoc node :__foo__ 4)))]
    (is (= expected actual))))

(deftest program-with-local-variable-whose-value-is-a-compile-time-constant
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziVariableDeclarationNode",
                                             :name "a",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 0}},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "a"}}]},
                                            {:__class__ "UziVariableDeclarationNode",
                                             :name "b",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 0}},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "b"}}]}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a#1"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "b#2"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "a#1",
                                       :value 0},
                                      {:__class__ "UziVariable",
                                       :name "b#2",
                                       :value 0}],
                             :name "default",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable" :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-local-variable-whose-value-is-a-compile-time-constant-different-than-zero
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziVariableDeclarationNode",
                                             :name "a",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 1}},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "a"}}]},
                                            {:__class__ "UziVariableDeclarationNode",
                                             :name "b",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 2}},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "b"}}]}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a#1"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "b#2"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle",}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "a#1",
                                       :value 1},
                                      {:__class__ "UziVariable",
                                       :name "b#2",
                                       :value 2}],
                             :name "default",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 1},
                               {:__class__ "UziVariable", :value 2}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-equal-nodes-referencing-different-variables
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "b"}],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziVariableDeclarationNode",
                                             :name "a",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 1}},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "b"}}]},
                                            {:__class__ "UziVariableDeclarationNode",
                                             :name "b",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 2}},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "b"}}]}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "b"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "b#2"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "a#1",
                                       :value 1},
                                      {:__class__ "UziVariable",
                                       :name "b#2",
                                       :value 2}],
                             :name "default",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :name "b", :value 0},
                               {:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 1},
                               {:__class__ "UziVariable", :value 2}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-assignment-to-global
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "temp"}],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "temp"},
                                             :right {:__class__ "UziNumberLiteralNode",
                                                     :value 0}}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 0}},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "temp",
                                                        :value 0}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :name "temp", :value 0},
                               {:__class__ "UziVariable", :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-assignment-to-local
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziVariableDeclarationNode",
                                             :name "temp",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 0}},
                                            {:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "temp"},
                                             :right {:__class__ "UziNumberLiteralNode",
                                                     :value 0}}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 0}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "temp#1",
                                                        :value 0}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "temp#1",
                                       :value 0}],
                             :name "default",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-procedure
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "default1",
                                             :arguments []}]}},
                       {:__class__ "UziProcedureNode",
                        :name "default1",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements []}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziScriptCallInstruction",
                                             :argument "default1"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [],
                             :locals [],
                             :name "default1",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable", :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-procedure-call-before-the-end-of-block
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "default1",
                                             :arguments []},
                                            {:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :type "D",
                                                                  :number 13}}]}]}},
                       {:__class__ "UziProcedureNode",
                        :name "default1",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements []}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziScriptCallInstruction",
                                             :argument "default1"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [],
                             :locals [],
                             :name "default1",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest procedure-with-one-argument
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "default1",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :type "D",
                                                                  :number 13}}]}]}},
                       {:__class__ "UziProcedureNode",
                        :name "default1",
                        :arguments [{:__class__ "UziVariableDeclarationNode",
                                     :name "arg0"}],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "arg0"}}]}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "default1"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [{:__class__ "UziVariable",
                                          :name "arg0#1",
                                          :value 0}],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "arg0#1",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "default1",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest program-with-function
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "temp"}],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "temp"},
                                             :right {:__class__ "UziCallNode",
                                                     :selector "default1",
                                                     :arguments []}}]}},
                       {:__class__ "UziFunctionNode",
                        :name "default1",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements []}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziScriptCallInstruction",
                                             :argument "default1"},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "temp",
                                                        :value 0}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [],
                             :locals [],
                             :name "default1",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable", :name "temp", :value 0},
                               {:__class__ "UziVariable", :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest function-with-one-arg
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "temp"}],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "temp"},
                                             :right {:__class__ "UziCallNode",
                                                     :selector "default1",
                                                     :arguments [{:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziPinLiteralNode",
                                                                          :type "D",
                                                                          :number 13}}]}}]}},
                       {:__class__ "UziFunctionNode",
                        :name "default1",
                        :arguments [{:__class__ "UziVariableDeclarationNode",
                                     :name "arg0"}],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "arg0"}}]}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "default1"},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable", :name "temp"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [{:__class__ "UziVariable",
                                          :name "arg0#1",
                                          :value 0}],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "arg0#1",}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "default1",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable",
                                :name "temp",
                                :value 0},
                               {:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest the-order-of-the-keys-in-a-program-map-should-not-matter
  (let [ast {:__class__ "UziProgramNode",
             :scripts [{:__class__ "UziTaskNode",
                        :name "empty",
                        :arguments [],
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :value 1,
                                      :scale "s"},
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "counter"},
                                             :right {:__class__ "UziCallNode",
                                                     :selector "+",
                                                     :arguments [{:__class__ "Association",
                                                                  :value {:__class__ "UziVariableNode",
                                                                          :name "counter"}},
                                                                 {:__class__ "Association",
                                                                  :value {:__class__ "UziNumberLiteralNode",
                                                                          :value 1}}]}}]}}],
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "counter"}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "counter",
                                                        ;:value 0
                                                        }},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        ;:code 6,
                                                        :name "add",
                                                        ;:stackTransition {:__class__ "Association",
                                                        ;                  :key 2,
                                                        ;                  :value 1}
                                                        }},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "counter",
                                                        ;:value 0
                                                        }}],
                             :locals [],
                             :name "empty",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :name "counter",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest the-order-of-the-keys-in-a-procedure-map-should-not-matter
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "default1",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :type "D",
                                                                  :number 13}}]}]}},
                       {:__class__ "UziProcedureNode",
                        :name "default1",
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "arg0"}}]}]},
                        :arguments [{:__class__ "UziVariableDeclarationNode",
                                     :name "arg0"}]}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "default1"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [{:__class__ "UziVariable",
                                          :name "arg0#1",
                                          :value 0}],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "arg0#1",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "default1",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest the-order-of-the-keys-in-a-function-map-should-not-matter
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "temp"}],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "temp"},
                                             :right {:__class__ "UziCallNode",
                                                     :selector "default1",
                                                     :arguments [{:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziPinLiteralNode",
                                                                          :type "D",
                                                                          :number 13}}]}}]}},
                       {:__class__ "UziFunctionNode",
                        :name "default1",
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "arg0"}}]}]},
                        :arguments [{:__class__ "UziVariableDeclarationNode",
                                     :name "arg0"}]}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "default1"},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable", :name "temp"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [{:__class__ "UziVariable",
                                          :name "arg0#1",
                                          :value 0}],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "arg0#1",}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "default1",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable",
                                :name "temp",
                                :value 0},
                               {:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest return-without-value
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziProcedureNode",
                        :name "default",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value nil}]}},
                       {:__class__ "UziTaskNode",
                        :name "loop",
                        :arguments [],
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :value 1,
                                      :scale "s"},
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "default",
                                             :arguments []}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "ret"}}],
                             :locals [],
                             :name "default",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 1000},
                             :instructions [{:__class__ "UziScriptCallInstruction",
                                             :argument "default"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}}],
                             :locals [],
                             :name "loop",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 1000}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest return-with-value
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziFunctionNode",
                        :name "addition",
                        :arguments [{:__class__ "UziVariableDeclarationNode",
                                     :name "x"},
                                    {:__class__ "UziVariableDeclarationNode",
                                     :name "y"}],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziCallNode",
                                                     :selector "+",
                                                     :arguments [{:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziVariableNode",
                                                                          :name "x"}},
                                                                 {:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziVariableNode",
                                                                          :name "y"}}]}}]}},
                       {:__class__ "UziTaskNode",
                        :name "loop",
                        :arguments [],
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :value 1,
                                      :scale "s"},
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "write",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :type "D",
                                                                  :number 13}},
                                                         {:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziCallNode",
                                                                  :selector "addition",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                                       :value 0.25}},
                                                                              {:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                                       :value 0.75}}]}}]}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [{:__class__ "UziVariable",
                                          :name "x#1",
                                          :value 0},
                                         {:__class__ "UziVariable",
                                          :name "y#2",
                                          :value 0}],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable", :name "x#1"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable", :name "y#2"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "addition",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 0.25}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 0.75}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "addition"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "write"}}],
                             :locals [],
                             :name "loop",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 1000},
                               {:__class__ "UziVariable", :value 13},
                               {:__class__ "UziVariable", :value 0.25},
                               {:__class__ "UziVariable", :value 0.75}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest task-control-nodes
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "loop",
                        :arguments [],
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :value 1,
                                      :scale "s"},
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "toggle",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :type "D",
                                                                  :number 13}}]}]}},
                       {:__class__ "UziTaskNode",
                        :name "main",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziScriptStartNode",
                                             :scripts ["loop"]},
                                            {:__class__ "UziScriptStopNode",
                                             :scripts ["loop"]},
                                            {:__class__ "UziScriptResumeNode",
                                             :scripts ["loop"]},
                                            {:__class__ "UziScriptPauseNode",
                                             :scripts ["loop"]},
                                            {:__class__ "UziCallNode",
                                             :selector "loop",
                                             :arguments []}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "loop",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziStartScriptInstruction",
                                             :argument "loop"},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "loop"},
                                            {:__class__ "UziResumeScriptInstruction",
                                             :argument "loop"},
                                            {:__class__ "UziPauseScriptInstruction",
                                             :argument "loop"},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "loop"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :value 1000},
                               {:__class__ "UziVariable", :value 13},
                               {:__class__ "UziVariable", :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest script-overriding-primitive
  (let [ast {:__class__ "UziProgramNode",
             :imports [],
             :globals [],
             :scripts [{:__class__ "UziTaskNode",
                        :name "default",
                        :arguments [],
                        :state "once",
                        :tickingRate nil,
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "turnOn",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziNumberLiteralNode",
                                                                  :value 0}}]}]}},
                       {:__class__ "UziProcedureNode",
                        :name "turnOn",
                        :arguments [{:__class__ "UziVariableDeclarationNode",
                                     :name "pin"}],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :selector "write",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "pin"}},
                                                         {:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziNumberLiteralNode",
                                                                  :value 1}}]}]}}],
             :primitives []}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 0}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "turnOn"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "default"}],
                             :locals [],
                             :name "default",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [{:__class__ "UziVariable",
                                          :name "pin#1",
                                          :value 0}],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "pin#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "write"}}],
                             :locals [],
                             :name "turnOn",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest program-with-yield-statement
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :number 13,
                                                                  :type "D"}}],
                                             :primitiveName "turnOn",
                                             :selector "turnOn"},
                                            {:__class__ "UziYieldNode"},
                                            {:__class__ "UziCallNode",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :number 13,
                                                                  :type "D"}}],
                                             :primitiveName "turnOff",
                                             :selector "turnOff"},
                                            {:__class__ "UziYieldNode"}]},
                        :name "main",
                        :state "running",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable", :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "turnOn"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "yield"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable", :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "turnOff"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "yield"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable", :value 0},
                               {:__class__ "UziVariable", :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest script-call-with-keyword-arguments
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :arguments [{:__class__ "Association",
                                                          :key "a",
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :number 9,
                                                                  :type "D"}},
                                                         {:__class__ "Association",
                                                          :key "c",
                                                          :value {:__class__ "UziNumberLiteralNode",
                                                                  :value 0.5}},
                                                         {:__class__ "Association",
                                                          :key "b",
                                                          :value {:__class__ "UziNumberLiteralNode",
                                                                  :value 0.75}}],
                                             :selector "foo"}]},
                        :name "main",
                        :state "running",
                        :tickingRate nil},
                       {:__class__ "UziProcedureNode",
                        :arguments [{:__class__ "UziVariableDeclarationNode",
                                     :name "a",
                                     :value nil},
                                    {:__class__ "UziVariableDeclarationNode",
                                     :name "b",
                                     :value nil},
                                    {:__class__ "UziVariableDeclarationNode",
                                     :name "c",
                                     :value nil}],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziCallNode",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "a"}},
                                                         {:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziVariableNode",
                                                                                       :name "b"}},
                                                                              {:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziVariableNode",
                                                                                       :name "c"}}],
                                                                  :selector "+"}}],
                                             :selector "write"}]},
                        :name "foo",
                        :state nil,
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 9}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0.75}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0.5}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "foo"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "pop"}}],
                             :locals [],
                             :name "main",
                             :running? true},
                            {:__class__ "UziScript",
                             :arguments [{:__class__ "UziVariable",
                                          :name "a#1",
                                          :value 0},
                                         {:__class__ "UziVariable",
                                          :name "b#2",
                                          :value 0},
                                         {:__class__ "UziVariable",
                                          :name "c#3",
                                          :value 0}],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a#1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "b#2",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "c#3",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "write"}}],
                             :locals [],
                             :name "foo",
                             :running? false}],
                  :globals #{{:__class__ "UziVariable",
                               :value 0},
                              {:__class__ "UziVariable",
                               :value 9},
                              {:__class__ "UziVariable",
                               :value 0.75},
                               {:__class__ "UziVariable",
                                :value 0.5}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest full-conditional
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziCallNode",
                                                         :arguments [{:__class__ "Association",
                                                                      :key nil,
                                                                      :value {:__class__ "UziPinLiteralNode",
                                                                              :number 13,
                                                                              :type "D"}}],
                                                         :selector "isOn"},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements [{:__class__ "UziCallNode",
                                                                         :arguments [{:__class__ "Association",
                                                                                      :key nil,
                                                                                      :value {:__class__ "UziPinLiteralNode",
                                                                                              :number 13,
                                                                                              :type "D"}}],
                                                                         :selector "turnOn"}]},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "turnOff"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "isOn"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 3},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "turnOff"}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "turnOn"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest conditional-with-only-true-branch
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziCallNode",
                                                         :arguments [{:__class__ "Association",
                                                                      :key nil,
                                                                      :value {:__class__ "UziPinLiteralNode",
                                                                              :number 13,
                                                                              :type "D"}}],
                                                         :selector "isOn"},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "turnOff"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "isOn"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "turnOff"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest conditional-with-only-false-branch
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziCallNode",
                                                         :arguments [{:__class__ "Association",
                                                                      :key nil,
                                                                      :value {:__class__ "UziPinLiteralNode",
                                                                              :number 13,
                                                                              :type "D"}}],
                                                         :selector "isOn"},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements [{:__class__ "UziCallNode",
                                                                         :arguments [{:__class__ "Association",
                                                                                      :key nil,
                                                                                      :value {:__class__ "UziPinLiteralNode",
                                                                                              :number 13,
                                                                                              :type "D"}}],
                                                                         :selector "turnOn"}]},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements []}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "isOn"}},
                                            {:__class__ "UziJNZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "turnOn"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                               :value 1000},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest forever-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziForeverNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziPinLiteralNode",
                                                                                       :number 13,
                                                                                       :type "D"}}],
                                                                  :selector "toggle"}]}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -3},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest while-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziWhileNode",
                                             :condition {:__class__ "UziNumberLiteralNode",
                                                         :value 1},
                                             :negated false,
                                             :post {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziPinLiteralNode",
                                                                                       :number 13,
                                                                                       :type "D"}}],
                                                                  :selector "toggle"}]},
                                             :pre {:__class__ "UziBlockNode",
                                                   :statements []}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 3},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -5},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest until-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziUntilNode",
                                             :condition {:__class__ "UziNumberLiteralNode",
                                                         :value 1},
                                             :negated true,
                                             :post {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziPinLiteralNode",
                                                                                       :number 13,
                                                                                       :type "D"}}],
                                                                  :selector "toggle"}]},
                                             :pre {:__class__ "UziBlockNode",
                                                   :statements []}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJNZInstruction",
                                             :argument 3},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -5},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest do-while-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziDoWhileNode",
                                             :condition {:__class__ "UziNumberLiteralNode",
                                                         :value 1},
                                             :negated false,
                                             :post {:__class__ "UziBlockNode",
                                                    :statements []},
                                             :pre {:__class__ "UziBlockNode",
                                                   :statements [{:__class__ "UziCallNode",
                                                                 :arguments [{:__class__ "Association",
                                                                              :key nil,
                                                                              :value {:__class__ "UziPinLiteralNode",
                                                                                      :number 13,
                                                                                      :type "D"}}],
                                                                 :selector "toggle"}]}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJNZInstruction",
                                             :argument -4},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 13},
                               {:__class__ "UziVariable",
                                :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest do-until-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziDoUntilNode",
                                             :condition {:__class__ "UziNumberLiteralNode",
                                                         :value 1},
                                             :negated true,
                                             :post {:__class__ "UziBlockNode",
                                                    :statements []},
                                             :pre {:__class__ "UziBlockNode",
                                                   :statements [{:__class__ "UziCallNode",
                                                                 :arguments [{:__class__ "Association",
                                                                              :key nil,
                                                                              :value {:__class__ "UziPinLiteralNode",
                                                                                      :number 13,
                                                                                      :type "D"}}],
                                                                 :selector "toggle"}]}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJZInstruction",
                                             :argument -4},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 13},
                               {:__class__ "UziVariable",
                                :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest wait-while-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziWhileNode",
                                             :condition {:__class__ "UziCallNode",
                                                         :arguments [{:__class__ "Association",
                                                                      :key nil,
                                                                      :value {:__class__ "UziPinLiteralNode",
                                                                              :number 9,
                                                                              :type "D"}}],
                                                         :selector "isOn"},
                                             :negated false,
                                             :post {:__class__ "UziBlockNode",
                                                    :statements []},
                                             :pre {:__class__ "UziBlockNode",
                                                   :statements []}},
                                            {:__class__ "UziCallNode",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :number 13,
                                                                  :type "D"}}],
                                             :selector "toggle"}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected  {:__class__ "UziProgram",
                   :scripts [{:__class__ "UziScript",
                              :arguments [],
                              :delay {:__class__ "UziVariable",
                                      :value 0},
                              :instructions [{:__class__ "UziPushInstruction",
                                              :argument {:__class__ "UziVariable",
                                                         :value 9}},
                                             {:__class__ "UziPrimitiveCallInstruction",
                                              :argument {:__class__ "UziPrimitive",
                                                         :name "isOn"}},
                                             {:__class__ "UziJNZInstruction",
                                              :argument -3},
                                             {:__class__ "UziPushInstruction",
                                              :argument {:__class__ "UziVariable",
                                                         :value 13}},
                                             {:__class__ "UziPrimitiveCallInstruction",
                                              :argument {:__class__ "UziPrimitive",
                                                         :name "toggle"}},
                                             {:__class__ "UziStopScriptInstruction",
                                              :argument "main"}],
                              :locals [],
                              :name "main",
                              :running? true}],
                   :globals #{{:__class__ "UziVariable",
                                 :value 0},
                                {:__class__ "UziVariable",
                                 :value 9},
                                {:__class__ "UziVariable",
                                 :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest wait-until-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziUntilNode",
                                             :condition {:__class__ "UziCallNode",
                                                         :arguments [{:__class__ "Association",
                                                                      :key nil,
                                                                      :value {:__class__ "UziPinLiteralNode",
                                                                              :number 9,
                                                                              :type "D"}}],
                                                         :selector "isOn"},
                                             :negated true,
                                             :post {:__class__ "UziBlockNode",
                                                    :statements []},
                                             :pre {:__class__ "UziBlockNode",
                                                   :statements []}},
                                            {:__class__ "UziCallNode",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziPinLiteralNode",
                                                                  :number 13,
                                                                  :type "D"}}],
                                             :selector "toggle"}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected  {:__class__ "UziProgram",
                   :scripts [{:__class__ "UziScript",
                              :arguments [],
                              :delay {:__class__ "UziVariable",
                                      :value 0},
                              :instructions [{:__class__ "UziPushInstruction",
                                              :argument {:__class__ "UziVariable",
                                                         :value 9}},
                                             {:__class__ "UziPrimitiveCallInstruction",
                                              :argument {:__class__ "UziPrimitive",
                                                         :name "isOn"}},
                                             {:__class__ "UziJZInstruction",
                                              :argument -3},
                                             {:__class__ "UziPushInstruction",
                                              :argument {:__class__ "UziVariable",
                                                         :value 13}},
                                             {:__class__ "UziPrimitiveCallInstruction",
                                              :argument {:__class__ "UziPrimitive",
                                                         :name "toggle"}},
                                             {:__class__ "UziStopScriptInstruction",
                                              :argument "main"}],
                              :locals [],
                              :name "main",
                              :running? true}],
                   :globals #{{:__class__ "UziVariable",
                                 :value 0},
                                {:__class__ "UziVariable",
                                 :value 9},
                                {:__class__ "UziVariable",
                                 :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest for-with-constant-step-and-constant-counter
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziForNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziVariableNode",
                                                                                       :name "i"}}],
                                                                  :selector "toggle"}]},
                                             :counter {:__class__ "UziVariableDeclarationNode",
                                                       :name "i",
                                                       :value nil},
                                             :start {:__class__ "UziNumberLiteralNode",
                                                     :value 1},
                                             :step {:__class__ "UziNumberLiteralNode",
                                                    :value 1},
                                             :stop {:__class__ "UziNumberLiteralNode",
                                                    :value 10}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 10}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "lessThanOrEquals"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 7},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -11},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "i#1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 10}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest for-with-constant-step
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziFunctionNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 1}}]},
                        :name "start",
                        :state nil,
                        :tickingRate nil},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziForNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziVariableNode",
                                                                                       :name "i"}}],
                                                                  :selector "toggle"}]},
                                             :counter {:__class__ "UziVariableDeclarationNode",
                                                       :name "i",
                                                       :value nil},
                                             :start {:__class__ "UziCallNode",
                                                     :arguments [],
                                                     :selector "start"},
                                             :step {:__class__ "UziNumberLiteralNode",
                                                    :value 1},
                                             :stop {:__class__ "UziNumberLiteralNode",
                                                    :value 10}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "start",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziScriptCallInstruction",
                                             :argument "start"},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 10}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "lessThanOrEquals"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 7},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -11},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "i#1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 10}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest for-with-constant-negative-step
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziForNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziPinLiteralNode",
                                                                                       :number 9,
                                                                                       :type "D"}},
                                                                              {:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziCallNode",
                                                                                       :arguments [{:__class__ "Association",
                                                                                                    :key nil,
                                                                                                    :value {:__class__ "UziVariableNode",
                                                                                                            :name "i"}},
                                                                                                   {:__class__ "Association",
                                                                                                    :key nil,
                                                                                                    :value {:__class__ "UziNumberLiteralNode",
                                                                                                            :value 100}}],
                                                                                       :selector "/"}}],
                                                                  :selector "write"}]},
                                             :counter {:__class__ "UziVariableDeclarationNode",
                                                       :name "i",
                                                       :value nil},
                                             :start {:__class__ "UziNumberLiteralNode",
                                                     :value 100},
                                             :step {:__class__ "UziNumberLiteralNode",
                                                    :value -10},
                                             :stop {:__class__ "UziNumberLiteralNode",
                                                    :value 0}}]},
                        :name "main",
                        :state "running",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 100}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "greaterThanOrEquals"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 10},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 9}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 100}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "divide"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "write"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value -10}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -14}],
                             :locals [{:__class__ "UziVariable",
                                       :name "i#1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 100},
                               {:__class__ "UziVariable",
                                :value 9},
                               {:__class__ "UziVariable",
                                :value -10}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest for-without-constant-step
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziFunctionNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 1}}]},
                        :name "step",
                        :state nil,
                        :tickingRate nil},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziForNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziVariableNode",
                                                                                       :name "i"}}],
                                                                  :selector "toggle"}]},
                                             :counter {:__class__ "UziVariableDeclarationNode",
                                                       :name "i",
                                                       :value nil},
                                             :start {:__class__ "UziNumberLiteralNode",
                                                     :value 1},
                                             :step {:__class__ "UziCallNode",
                                                    :arguments [],
                                                    :selector "step"},
                                             :stop {:__class__ "UziNumberLiteralNode",
                                                    :value 10}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "step",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 10}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "step"},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziJLTEInstruction",
                                             :argument 2},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "lessThanOrEquals"}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument 1},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "greaterThanOrEquals"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 7},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -18},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "i#1",
                                       :value 0},
                                      {:__class__ "UziVariable",
                                       :name "@1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 10}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest repeat-loop
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziFunctionNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 100}}]},
                        :name "step",
                        :state nil,
                        :tickingRate nil},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziRepeatNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziPinLiteralNode",
                                                                                       :number 13,
                                                                                       :type "D"}}],
                                                                  :selector "toggle"},
                                                                 {:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                                       :value 1000}}],
                                                                  :selector "delayMs"}]},
                                             :times {:__class__ "UziCallNode",
                                                     :arguments [],
                                                     :selector "step"}}]},
                        :name "main",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 100}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "step",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "step"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "lessThan"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 9},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1000}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "delayMs"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -13},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "main"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "@1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 100},
                               {:__class__ "UziVariable",
                                :value 13},
                               {:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest repeat-loop-declares-0-and-1-as-global-constants
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziRepeatNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziPinLiteralNode",
                                                                                       :number 13,
                                                                                       :type "D"}}],
                                                                  :selector "toggle"}]},
                                             :times {:__class__ "UziNumberLiteralNode",
                                                     :value 5}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 5}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "lessThan"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 7},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "@1",
                                                        :value 0}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -11}],
                             :locals [{:__class__ "UziVariable",
                                       :name "@1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 5},
                               {:__class__ "UziVariable",
                                :value 13},
                               {:__class__ "UziVariable",
                                :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest for-loop-declares-0-as-global-constant
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziForNode",
                                             :body {:__class__ "UziBlockNode",
                                                    :statements [{:__class__ "UziCallNode",
                                                                  :arguments [{:__class__ "Association",
                                                                               :key nil,
                                                                               :value {:__class__ "UziPinLiteralNode",
                                                                                       :number 13,
                                                                                       :type "D"}}],
                                                                  :selector "toggle"}]},
                                             :counter {:__class__ "UziVariableDeclarationNode",
                                                       :name "i",
                                                       :value nil},
                                             :start {:__class__ "UziNumberLiteralNode",
                                                     :value 1},
                                             :step {:__class__ "UziNumberLiteralNode",
                                                    :value 2},
                                             :stop {:__class__ "UziNumberLiteralNode",
                                                    :value 10}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 10}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "lessThanOrEquals"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 7},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 2}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "i#1",
                                                        :value 0}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument -11}],
                             :locals [{:__class__ "UziVariable",
                                       :name "i#1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 10},
                               {:__class__ "UziVariable",
                                :value 13},
                               {:__class__ "UziVariable",
                                :value 2}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest local-values-are-registered-as-global-constants
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziVariableDeclarationNode",
                                             :name "a",
                                             :value nil},
                                            {:__class__ "UziCallNode",
                                             :arguments [{:__class__ "Association",
                                                          :key nil,
                                                          :value {:__class__ "UziVariableNode",
                                                                  :name "a"}}],
                                             :selector "toggle"}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a#1",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [{:__class__ "UziVariable",
                                       :name "a#1",
                                       :value 0}],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 0}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))



(deftest logical-and-without-short-circuit
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalAndNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 1},
                                                         :right {:__class__ "UziNumberLiteralNode",
                                                                 :value 0}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "logicalAnd"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest logical-and-with-short-circuit
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziFunctionNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 42}}]},
                        :name "foo",
                        :state nil,
                        :tickingRate nil},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalAndNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 1},
                                                         :right {:__class__ "UziCallNode",
                                                                 :arguments [],
                                                                 :selector "foo"}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 42}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "foo",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "foo"},
                                            {:__class__ "UziJMPInstruction",
                                             :argument 1},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 42},
                               {:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest logical-or-without-short-circuit
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalOrNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 1},
                                                         :right {:__class__ "UziNumberLiteralNode",
                                                                 :value 0}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "logicalOr"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest logical-or-with-short-circuit
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziFunctionNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 42}}]},
                        :name "foo",
                        :state nil,
                        :tickingRate nil},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalOrNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 1},
                                                         :right {:__class__ "UziCallNode",
                                                                 :arguments [],
                                                                 :selector "foo"}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 42}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "foo",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJNZInstruction",
                                             :argument 2},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "foo"},
                                            {:__class__ "UziJMPInstruction",
                                             :argument 1},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 42},
                               {:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest logical-and-with-short-circuit-declares-0-as-global-constant
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 42}}]},
                        :name "foo",
                        :state "stopped",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalAndNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 2},
                                                         :right {:__class__ "UziCallNode",
                                                                 :arguments [],
                                                                 :selector "foo"}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 42}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "foo",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 2}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "foo"},
                                            {:__class__ "UziJMPInstruction",
                                             :argument 1},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 42},
                               {:__class__ "UziVariable",
                                :value 2},
                               {:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest logical-or-with-short-circuit-declares-1-as-global-constant
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziFunctionNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 42}}]},
                        :name "foo",
                        :state nil,
                        :tickingRate nil},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalOrNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 2},
                                                         :right {:__class__ "UziCallNode",
                                                                 :arguments [],
                                                                 :selector "foo"}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "main",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 42}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "foo",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 2}},
                                            {:__class__ "UziJNZInstruction",
                                             :argument 2},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "foo"},
                                            {:__class__ "UziJMPInstruction",
                                             :argument 1},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "main",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 42},
                               {:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 2},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest has-side-effects-checks-the-arguments-of-a-call
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziFunctionNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziReturnNode",
                                             :value {:__class__ "UziPinLiteralNode",
                                                     :number 13,
                                                     :type "D"}}]},
                        :name "pin13",
                        :state nil,
                        :tickingRate nil},
                       {:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalAndNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 1},
                                                         :right {:__class__ "UziCallNode",
                                                                 :arguments [{:__class__ "Association",
                                                                              :key nil,
                                                                              :value {:__class__ "UziCallNode",
                                                                                      :arguments [],
                                                                                      :selector "pin13"}}],
                                                                 :selector "isOn"}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziCallNode",
                                                                                             :arguments [],
                                                                                             :selector "pin13"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "loop",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "retv"}}],
                             :locals [],
                             :name "pin13",
                             :running? false},
                            {:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 3},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "pin13"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "isOn"}},
                                            {:__class__ "UziJMPInstruction",
                                             :argument 1},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 0}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziScriptCallInstruction",
                                             :argument "pin13"},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "loop",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 13},
                               {:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))

(deftest has-side-effects-checks-the-arguments-of-a-call-2
  (let [ast {:__class__ "UziProgramNode",
             :globals [],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziConditionalNode",
                                             :condition {:__class__ "UziLogicalAndNode",
                                                         :left {:__class__ "UziNumberLiteralNode",
                                                                :value 1},
                                                         :right {:__class__ "UziCallNode",
                                                                 :arguments [{:__class__ "Association",
                                                                              :key nil,
                                                                              :value {:__class__ "UziPinLiteralNode",
                                                                                      :number 13,
                                                                                      :type "D"}}],
                                                                 :selector "isOn"}},
                                             :falseBranch {:__class__ "UziBlockNode",
                                                           :statements []},
                                             :trueBranch {:__class__ "UziBlockNode",
                                                          :statements [{:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key nil,
                                                                                     :value {:__class__ "UziPinLiteralNode",
                                                                                             :number 13,
                                                                                             :type "D"}}],
                                                                        :selector "toggle"}]}}]},
                        :name "loop",
                        :state "running",
                        :tickingRate {:__class__ "UziTickingRateNode",
                                      :scale "s",
                                      :value 1}}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 1000},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "isOn"}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "logicalAnd"}},
                                            {:__class__ "UziJZInstruction",
                                             :argument 2},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 13}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "toggle"}}],
                             :locals [],
                             :name "loop",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :value 1000},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 13}}}
        actual (compile ast)]
    (is (equivalent? expected actual))))


(deftest local-variable-declared-multiple-times-inside-script
    (let [ast {:__class__ "UziProgramNode",
               :globals [{:__class__ "UziVariableDeclarationNode",
                          :name "a",
                          :value {:__class__ "UziNumberLiteralNode",
                                  :value 42}}],
               :imports [],
               :primitives [],
               :scripts [{:__class__ "UziTaskNode",
                          :arguments [],
                          :body {:__class__ "UziBlockNode",
                                 :statements [{:__class__ "UziCallNode",
                                               :arguments [{:__class__ "Association",
                                                            :key nil,
                                                            :value {:__class__ "UziPinLiteralNode",
                                                                    :number 12,
                                                                    :type "D"}},
                                                           {:__class__ "Association",
                                                            :key nil,
                                                            :value {:__class__ "UziVariableNode",
                                                                    :name "a"}}],
                                               :selector "write"},
                                              {:__class__ "UziConditionalNode",
                                               :condition {:__class__ "UziCallNode",
                                                           :arguments [{:__class__ "Association",
                                                                        :key nil,
                                                                        :value {:__class__ "UziNumberLiteralNode",
                                                                                :value 0}}],
                                                           :selector "isOn"},
                                               :trueBranch {:__class__ "UziBlockNode",
                                                            :statements [{:__class__ "UziVariableDeclarationNode",
                                                                          :name "a",
                                                                          :value {:__class__ "UziNumberLiteralNode",
                                                                                  :value -10}},
                                                                         {:__class__ "UziCallNode",
                                                                          :arguments [{:__class__ "Association",
                                                                                       :key nil,
                                                                                       :value {:__class__ "UziPinLiteralNode",
                                                                                               :number 13,
                                                                                               :type "D"}},
                                                                                      {:__class__ "Association",
                                                                                       :key nil,
                                                                                       :value {:__class__ "UziVariableNode",
                                                                                               :name "a"}}],
                                                                          :selector "write"}]}
                                               :falseBranch {:__class__ "UziBlockNode",
                                                             :statements [{:__class__ "UziVariableDeclarationNode",
                                                                           :name "a",
                                                                           :value {:__class__ "UziNumberLiteralNode",
                                                                                   :value 10}},
                                                                          {:__class__ "UziCallNode",
                                                                           :arguments [{:__class__ "Association",
                                                                                        :key nil,
                                                                                        :value {:__class__ "UziPinLiteralNode",
                                                                                                :number 13,
                                                                                                :type "D"}},
                                                                                       {:__class__ "Association",
                                                                                        :key nil,
                                                                                        :value {:__class__ "UziVariableNode",
                                                                                                :name "a"}}],
                                                                           :selector "write"}]}},
                                              {:__class__ "UziCallNode",
                                               :arguments [{:__class__ "Association",
                                                            :key nil,
                                                            :value {:__class__ "UziPinLiteralNode",
                                                                    :number 12,
                                                                    :type "D"}},
                                                           {:__class__ "Association",
                                                            :key nil,
                                                            :value {:__class__ "UziCallNode",
                                                                    :arguments [{:__class__ "Association",
                                                                                 :key nil,
                                                                                 :value {:__class__ "UziNumberLiteralNode",
                                                                                         :value -1}},
                                                                                {:__class__ "Association",
                                                                                 :key nil,
                                                                                 :value {:__class__ "UziVariableNode",
                                                                                         :name "a"}}],
                                                                    :selector "*"}}],
                                               :selector "write"}]},
                          :name "loop",
                          :state "running",
                          :tickingRate {:__class__ "UziTickingRateNode",
                                        :scale "s",
                                        :value 1}}]}
          expected {:__class__ "UziProgram",
                    :scripts [{:__class__ "UziScript",
                               :arguments [],
                               :delay {:__class__ "UziVariable",
                                       :value 1000},
                               :instructions [{:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 12}},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a"}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "write"}},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 0}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "isOn"}},
                                              {:__class__ "UziJZInstruction",
                                               :argument 4},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 13}},
                                              {:__class__ "UziReadLocalInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a#1"}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "write"}},
                                              {:__class__ "UziJMPInstruction",
                                               :argument 3},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 13}},
                                              {:__class__ "UziReadLocalInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a#2"}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "write"}},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 12}},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value -1}},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a"}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "multiply"}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "write"}}],
                               :locals [{:__class__ "UziVariable",
                                         :name "a#1",
                                         :value -10},
                                        {:__class__ "UziVariable",
                                         :name "a#2",
                                         :value 10}],
                               :name "loop",
                               :running? true}],
                    :globals #{{:__class__ "UziVariable" :name "a" :value 42},
                                 {:__class__ "UziVariable" :value 1000},
                                 {:__class__ "UziVariable" :value 12},
                                 {:__class__ "UziVariable" :value 13},
                                 {:__class__ "UziVariable" :value -10},
                                 {:__class__ "UziVariable" :value 10},
                                 {:__class__ "UziVariable" :value -1}
                                 {:__class__ "UziVariable", :value 0}}}
          actual (compile ast)]
      (is (equivalent? expected actual))
      (is (= (:globals expected)
             (:globals actual)))))


(deftest global-variable-with-value-different-than-default
  (let [ast {:__class__ "UziProgramNode",
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "a",
                        :value {:__class__ "UziNumberLiteralNode",
                                :value 42}}],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "a"},
                                             :right {:__class__ "UziCallNode",
                                                     :arguments [{:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziVariableNode",
                                                                          :name "a"}},
                                                                 {:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziNumberLiteralNode",
                                                                          :value 10}}],
                                                     :selector "+"}}]},
                        :name "loop",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 10}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "loop"}],
                             :locals [],
                             :name "loop",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :name "a",
                                :value 42},
                               {:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 10}}}
        actual (compile ast)]
    (is (equivalent? expected actual))
    (is (= (:globals expected)
           (:globals actual)))))

(deftest local-variable-shadowing-global-variable
  (let [ast {:__class__ "UziProgramNode",
             :globals [{:__class__ "UziVariableDeclarationNode",
                        :name "a",
                        :value {:__class__ "UziNumberLiteralNode",
                                :value 42}}],
             :imports [],
             :primitives [],
             :scripts [{:__class__ "UziTaskNode",
                        :arguments [],
                        :body {:__class__ "UziBlockNode",
                               :statements [{:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "a"},
                                             :right {:__class__ "UziCallNode",
                                                     :arguments [{:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziVariableNode",
                                                                          :name "a"}},
                                                                 {:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziNumberLiteralNode",
                                                                          :value 1}}],
                                                     :selector "+"}},
                                            {:__class__ "UziVariableDeclarationNode",
                                             :name "a",
                                             :value {:__class__ "UziNumberLiteralNode",
                                                     :value 15}},
                                            {:__class__ "UziAssignmentNode",
                                             :left {:__class__ "UziVariableNode",
                                                    :name "a"},
                                             :right {:__class__ "UziCallNode",
                                                     :arguments [{:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziVariableNode",
                                                                          :name "a"}},
                                                                 {:__class__ "Association",
                                                                  :key nil,
                                                                  :value {:__class__ "UziNumberLiteralNode",
                                                                          :value 42}}],
                                                     :selector "+"}}]},
                        :name "loop",
                        :state "once",
                        :tickingRate nil}]}
        expected {:__class__ "UziProgram",
                  :scripts [{:__class__ "UziScript",
                             :arguments [],
                             :delay {:__class__ "UziVariable",
                                     :value 0},
                             :instructions [{:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 1}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziPopInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a"}},
                                            {:__class__ "UziReadLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a#1"}},
                                            {:__class__ "UziPushInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :value 42}},
                                            {:__class__ "UziPrimitiveCallInstruction",
                                             :argument {:__class__ "UziPrimitive",
                                                        :name "add"}},
                                            {:__class__ "UziWriteLocalInstruction",
                                             :argument {:__class__ "UziVariable",
                                                        :name "a#1"}},
                                            {:__class__ "UziStopScriptInstruction",
                                             :argument "loop"}],
                             :locals [{:__class__ "UziVariable",
                                       :name "a#1",
                                       :value 15}],
                             :name "loop",
                             :running? true}],
                  :globals #{{:__class__ "UziVariable",
                                :name "a",
                                :value 42},
                               {:__class__ "UziVariable",
                                :value 0},
                               {:__class__ "UziVariable",
                                :value 1},
                               {:__class__ "UziVariable",
                                :value 15},
                               {:__class__ "UziVariable",
                                :value 42}}}
        actual (compile ast)]
    (is (equivalent? expected actual))
    (is (= (:globals expected)
           (:globals actual)))))


(deftest conditional-children-order-should-not-impact-compilation
    (let [ast {:__class__ "UziProgramNode",
               :globals [],
               :imports [],
               :primitives [],
               :scripts [{:__class__ "UziTaskNode",
                          :arguments [],
                          :body {:__class__ "UziBlockNode",
                                 :statements [{:__class__ "UziConditionalNode",
                                               :condition {:__class__ "UziCallNode",
                                                           :arguments [{:__class__ "Association",
                                                                        :key nil,
                                                                        :value {:__class__ "UziPinLiteralNode",
                                                                                :number 9,
                                                                                :type "D"}}],
                                                           :selector "isOn"},
                                               :falseBranch {:__class__ "UziBlockNode",
                                                             :statements [{:__class__ "UziVariableDeclarationNode",
                                                                           :name "a",
                                                                           :value {:__class__ "UziNumberLiteralNode",
                                                                                   :value 21}},
                                                                          {:__class__ "UziAssignmentNode",
                                                                           :left {:__class__ "UziVariableNode",
                                                                                  :name "a"},
                                                                           :right {:__class__ "UziCallNode",
                                                                                   :arguments [{:__class__ "Association",
                                                                                                :key nil,
                                                                                                :value {:__class__ "UziVariableNode",
                                                                                                        :name "a"}},
                                                                                               {:__class__ "Association",
                                                                                                :key nil,
                                                                                                :value {:__class__ "UziNumberLiteralNode",
                                                                                                        :value 20}}],
                                                                                   :selector "+"}}]},
                                               :trueBranch {:__class__ "UziBlockNode",
                                                            :statements [{:__class__ "UziVariableDeclarationNode",
                                                                          :name "a",
                                                                          :value {:__class__ "UziNumberLiteralNode",
                                                                                  :value 11}},
                                                                         {:__class__ "UziAssignmentNode",
                                                                          :left {:__class__ "UziVariableNode",
                                                                                 :name "a"},
                                                                          :right {:__class__ "UziCallNode",
                                                                                  :arguments [{:__class__ "Association",
                                                                                               :key nil,
                                                                                               :value {:__class__ "UziVariableNode",
                                                                                                       :name "a"}},
                                                                                              {:__class__ "Association",
                                                                                               :key nil,
                                                                                               :value {:__class__ "UziNumberLiteralNode",
                                                                                                       :value 10}}],
                                                                                  :selector "+"}}]}}]},
                          :name "loop",
                          :state "once",
                          :tickingRate nil}]}
          expected {:__class__ "UziProgram",
                    :scripts [{:__class__ "UziScript",
                               :arguments [],
                               :delay {:__class__ "UziVariable",
                                       :value 0},
                               :instructions [{:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 9}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "isOn"}},
                                              {:__class__ "UziJZInstruction",
                                               :argument 5},
                                              {:__class__ "UziReadLocalInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a#1"}},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 10}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "add"}},
                                              {:__class__ "UziWriteLocalInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a#1"}},
                                              {:__class__ "UziJMPInstruction",
                                               :argument 4},
                                              {:__class__ "UziReadLocalInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a#2"}},
                                              {:__class__ "UziPushInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :value 20}},
                                              {:__class__ "UziPrimitiveCallInstruction",
                                               :argument {:__class__ "UziPrimitive",
                                                          :name "add"}},
                                              {:__class__ "UziWriteLocalInstruction",
                                               :argument {:__class__ "UziVariable",
                                                          :name "a#2"}},
                                              {:__class__ "UziStopScriptInstruction",
                                               :argument "loop"}],
                               :locals [{:__class__ "UziVariable",
                                         :name "a#1",
                                         :value 11},
                                        {:__class__ "UziVariable",
                                         :name "a#2",
                                         :value 21}],
                               :name "loop",
                               :running? true}],
                    :globals #{{:__class__ "UziVariable",
                                  :value 0},
                                 {:__class__ "UziVariable",
                                  :value 9},
                                 {:__class__ "UziVariable",
                                  :value 11},
                                 {:__class__ "UziVariable",
                                  :value 10},
                                 {:__class__ "UziVariable",
                                  :value 21},
                                 {:__class__ "UziVariable",
                                  :value 20}}}
          actual (compile ast)]
      (is (equivalent? expected actual))
      (is (= (:globals expected)
             (:globals actual)))))

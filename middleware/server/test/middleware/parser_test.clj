(ns middleware.parser-test
  (:require [clojure.test :refer :all]
            [middleware.parser.parser :as pp])
  (:use [middleware.test-utils]))

(def exclusions '#{custom-operator-precedence})

(defn parse [src]
  (if-not (contains? exclusions (symbol (test-name)))
    (register-program! src))
  (pp/parse src))

(deftest parsing-negative-numbers-larger-than-minus-1
  (let [src "task foo() { return -0.5; }"
        expected {:__class__ "UziProgramNode"
                  :scripts [{:__class__ "UziTaskNode"
                             :name "foo"
                             :state "once"
                             :body {:__class__ "UziBlockNode"
                                    :statements [{:__class__ "UziReturnNode",
                                                  :value     {:__class__ "UziNumberLiteralNode",
                                                              :value     -0.5}}]}}]}
        actual (parse src)]
    (is (equivalent? expected actual))))


(deftest empty-program
  (testing "An Empty Program"
    (let [src ""
          expected {:__class__  "UziProgramNode",
                    :imports    [],
                    :globals    [],
                    :scripts    [],
                    :primitives []}
          actual (parse src)]
      (is (equivalent? expected actual)))))

(deftest blink13
  (testing "A Task that blinks the pin 13"
    (let [src "task default() running 1/s {\n\ttoggle(D13);\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [],
                    :globals    [],
                    :scripts    [{:__class__   "UziTaskNode",
                                  :name        "default",
                                  :arguments   [],
                                  :state       "running",
                                  :tickingRate {:__class__ "UziTickingRateNode",
                                                :value     1,
                                                :scale     "s"},
                                  :body        {:__class__  "UziBlockNode",
                                                :statements [{:__class__ "UziCallNode",
                                                              :selector  "toggle",
                                                              :arguments [{:__class__ "Association",
                                                                           :key       nil,
                                                                           :value     {:__class__ "UziPinLiteralNode",
                                                                                       :type      "D",
                                                                                       :number    13}}]}]}}],
                    :primitives []}
          actual (parse src)]
      (is (equivalent? expected actual)))))

(deftest procedure-with-argument
  (testing "A procedure with a single argument"
    (let [src "proc blink(arg0) {\n\tturnOn(arg0);\n\tdelayS(1);\n\tturnOff(arg0);\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [],
                    :globals    [],
                    :scripts    [{:__class__ "UziProcedureNode",
                                  :name      "blink",
                                  :arguments [{:__class__ "UziVariableDeclarationNode",
                                               :name      "arg0"}],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziCallNode",
                                                            :selector  "turnOn",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziVariableNode",
                                                                                     :name      "arg0"}}]},
                                                           {:__class__ "UziCallNode",
                                                            :selector  "delayS",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziNumberLiteralNode",
                                                                                     :value     1}}]},
                                                           {:__class__ "UziCallNode",
                                                            :selector  "turnOff",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziVariableNode",
                                                                                     :name      "arg0"}}]}]}}],
                    :primitives []}
          actual (parse src)]
      (is (equivalent? expected actual)))))

(deftest function-with-arguments
  (testing "A Function with two arguments and a return"
    (let [src "func default(arg0, arg1) {\n\treturn (arg0 % arg1);\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [],
                    :globals    [],
                    :scripts    [{:__class__ "UziFunctionNode",
                                  :name      "default",
                                  :arguments [{:__class__ "UziVariableDeclarationNode",
                                               :name      "arg0"},
                                              {:__class__ "UziVariableDeclarationNode",
                                               :name      "arg1"}],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziReturnNode",
                                                            :value     {:__class__ "UziCallNode",
                                                                        :selector  "%",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziVariableNode",
                                                                                                 :name      "arg0"}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziVariableNode",
                                                                                                 :name      "arg1"}}]}}]}}],
                    :primitives []}
          actual (parse src)]
      (is (equivalent? expected actual)))))

(deftest functions-with-calls-and-globals
  (testing "A program with two functions that modify a global"
    (let [src "var global;\n\nfunc forIncrease(from, to, by) {\n\tfor i = from to to by by {\n\t\tglobal = (global + 1);\n\t}\n\treturn global;\n}\n\nfunc run() {\n\tvar temp = forIncrease(1, 10, 0.5);\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [],
                    :globals    [{:__class__ "UziVariableDeclarationNode",
                                  :name      "global"}],
                    :scripts    [{:__class__ "UziFunctionNode",
                                  :name      "forIncrease",
                                  :arguments [{:__class__ "UziVariableDeclarationNode",
                                               :name      "from"},
                                              {:__class__ "UziVariableDeclarationNode",
                                               :name      "to"},
                                              {:__class__ "UziVariableDeclarationNode",
                                               :name      "by"}],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziForNode",
                                                            :counter   {:__class__ "UziVariableDeclarationNode",
                                                                        :name      "i"},
                                                            :start     {:__class__ "UziVariableNode",
                                                                        :name      "from"},
                                                            :stop      {:__class__ "UziVariableNode",
                                                                        :name      "to"},
                                                            :step      {:__class__ "UziVariableNode",
                                                                        :name      "by"},
                                                            :body      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziAssignmentNode",
                                                                                      :left      {:__class__ "UziVariableNode",
                                                                                                  :name      "global"},
                                                                                      :right     {:__class__ "UziCallNode",
                                                                                                  :selector  "+",
                                                                                                  :arguments [{:__class__ "Association",
                                                                                                               :key       nil,
                                                                                                               :value     {:__class__ "UziVariableNode",
                                                                                                                           :name      "global"}},
                                                                                                              {:__class__ "Association",
                                                                                                               :key       nil,
                                                                                                               :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                           :value     1}}]}}]}},
                                                           {:__class__ "UziReturnNode",
                                                            :value     {:__class__ "UziVariableNode",
                                                                        :name      "global"}}]}},
                                 {:__class__ "UziFunctionNode",
                                  :name      "run",
                                  :arguments [],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziVariableDeclarationNode",
                                                            :name      "temp",
                                                            :value     {:__class__ "UziCallNode",
                                                                        :selector  "forIncrease",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     1}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     10}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     0.5}}]}}]}}],
                    :primitives []}
          actual (parse src)
          ] (is (equivalent? expected actual)))))

(deftest operator-precedence
  ;TODO(Tera): This should probably test all the operators
  (testing "A Function with some of the operators to check if the correct precedence is being built"
    (let [src "func operate(arg0, arg1) {\n\treturn arg0 + arg1**2*3;\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [],
                    :globals    [],
                    :scripts    [{:__class__ "UziFunctionNode",
                                  :name      "operate",
                                  :arguments [{:__class__ "UziVariableDeclarationNode", :name "arg0"}
                                              {:__class__ "UziVariableDeclarationNode", :name "arg1"}],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziReturnNode",
                                                            :value     {:__class__ "UziCallNode",
                                                                        :selector  "+",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziVariableNode", :name "arg0"}}
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziCallNode",
                                                                                                 :selector  "*",
                                                                                                 :arguments [{:__class__ "Association",
                                                                                                              :key       nil,
                                                                                                              :value     {:__class__ "UziCallNode",
                                                                                                                          :selector  "**",
                                                                                                                          :arguments [{:__class__ "Association",
                                                                                                                                       :key       nil,
                                                                                                                                       :value     {:__class__ "UziVariableNode",
                                                                                                                                                   :name      "arg1"}}
                                                                                                                                      {:__class__ "Association",
                                                                                                                                       :key       nil,
                                                                                                                                       :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                                                   :value     2}}]}}
                                                                                                             {:__class__ "Association",
                                                                                                              :key       nil,
                                                                                                              :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                          :value     3}}]}}]}}]}}],
                    :primitives []}
          actual (parse src)
          ] (is (equivalent? expected actual)))
    ))
(deftest custom-operator-precedence
  (testing "a more complex squence of operators, including user defined ones"
    (let [src "\ntask blink13() running 2/s {\nreturn a * b/c**d+n ~ j ** 3;\n } "
          expected {:__class__  "UziProgramNode",
                    :globals    [],
                    :imports    [],
                    :primitives [],
                    :scripts    [{:__class__   "UziTaskNode",
                                  :arguments   [],
                                  :body        {:__class__  "UziBlockNode",
                                                :statements [{:__class__ "UziReturnNode",
                                                              :value     {:__class__ "UziCallNode",
                                                                          :arguments [{:__class__ "Association",
                                                                                       :key       nil,
                                                                                       :value     {:__class__ "UziCallNode",
                                                                                                   :arguments [{:__class__ "Association",
                                                                                                                :key       nil,
                                                                                                                :value     {:__class__ "UziCallNode",
                                                                                                                            :arguments [{:__class__ "Association",
                                                                                                                                         :key       nil,
                                                                                                                                         :value     {:__class__ "UziCallNode",
                                                                                                                                                     :arguments [{:__class__ "Association",
                                                                                                                                                                  :key       nil,
                                                                                                                                                                  :value     {:__class__ "UziVariableNode",
                                                                                                                                                                              :name      "a"}},
                                                                                                                                                                 {:__class__ "Association",
                                                                                                                                                                  :key       nil,
                                                                                                                                                                  :value     {:__class__ "UziVariableNode",
                                                                                                                                                                              :name      "b"}}],
                                                                                                                                                     :selector  "*"}},
                                                                                                                                        {:__class__ "Association",
                                                                                                                                         :key       nil,
                                                                                                                                         :value     {:__class__ "UziCallNode",
                                                                                                                                                     :arguments [{:__class__ "Association",
                                                                                                                                                                  :key       nil,
                                                                                                                                                                  :value     {:__class__ "UziVariableNode",
                                                                                                                                                                              :name      "c"}},
                                                                                                                                                                 {:__class__ "Association",
                                                                                                                                                                  :key       nil,
                                                                                                                                                                  :value     {:__class__ "UziVariableNode",
                                                                                                                                                                              :name      "d"}}],
                                                                                                                                                     :selector  "**"}}],
                                                                                                                            :selector  "/"}},
                                                                                                               {:__class__ "Association",
                                                                                                                :key       nil,
                                                                                                                :value     {:__class__ "UziVariableNode",
                                                                                                                            :name      "n"}}],
                                                                                                   :selector  "+"}},
                                                                                      {:__class__ "Association",
                                                                                       :key       nil,
                                                                                       :value     {:__class__ "UziCallNode",
                                                                                                   :arguments [{:__class__ "Association",
                                                                                                                :key       nil,
                                                                                                                :value     {:__class__ "UziVariableNode",
                                                                                                                            :name      "j"}},
                                                                                                               {:__class__ "Association",
                                                                                                                :key       nil,
                                                                                                                :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                            :value     3}}],
                                                                                                   :selector  "**"}}],
                                                                          :selector  "~"}}]},
                                  :name        "blink13",
                                  :state       "running",
                                  :tickingRate {:__class__ "UziTickingRateNode",
                                                :scale     "s",
                                                :value     2}}]}
          actual (parse src)]
      (is (equivalent? expected actual)))))

(deftest control-structures
  (testing "Several tasks with the main control structures on them"
    (let [src "task while_loop() {\n\twhile 1 {\n\t\twhile 1;\n\t}\n}\n\ntask until_loop() {\n\tuntil 1 {\n\t\tuntil 1;\n\t}\n}\n\ntask repeat_forever() {\n\tforever {\n\t\trepeat 5 {}\n\t}\n}\n\ntask conditional() {\n\tif 1 {\n\t\tif 0 {\n\t\t\tdelayS(1000);\n\t\t}\n\t} else {\n\t\tdelayMs(1000);\n\t}\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [],
                    :globals    [],
                    :scripts    [{:__class__ "UziTaskNode",
                                  :name      "while_loop",
                                  :arguments [],
                                  :state     "once",
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziWhileNode",
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements []},
                                                            :condition {:__class__ "UziNumberLiteralNode",
                                                                        :value     1},
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziWhileNode",
                                                                                      :pre       {:__class__  "UziBlockNode",
                                                                                                  :statements []},
                                                                                      :condition {:__class__ "UziNumberLiteralNode",
                                                                                                  :value     1},
                                                                                      :post      {:__class__  "UziBlockNode",
                                                                                                  :statements []},
                                                                                      :negated   false}]},
                                                            :negated   false}]}},
                                 {:__class__ "UziTaskNode",
                                  :name      "until_loop",
                                  :arguments [],
                                  :state     "once",
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziUntilNode",
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements []},
                                                            :condition {:__class__ "UziNumberLiteralNode",
                                                                        :value     1},
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziUntilNode",
                                                                                      :pre       {:__class__  "UziBlockNode",
                                                                                                  :statements []},
                                                                                      :condition {:__class__ "UziNumberLiteralNode",
                                                                                                  :value     1},
                                                                                      :post      {:__class__  "UziBlockNode",
                                                                                                  :statements []},
                                                                                      :negated   true}]},
                                                            :negated   true}]}},
                                 {:__class__ "UziTaskNode",
                                  :name      "repeat_forever",
                                  :arguments [],
                                  :state     "once",
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziForeverNode",
                                                            :body      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziRepeatNode",
                                                                                      :times     {:__class__ "UziNumberLiteralNode",
                                                                                                  :value     5},
                                                                                      :body      {:__class__  "UziBlockNode",
                                                                                                  :statements []}}]}}]}},
                                 {:__class__ "UziTaskNode",
                                  :name      "conditional",
                                  :arguments [],
                                  :state     "once",
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__   "UziConditionalNode",
                                                            :condition   {:__class__ "UziNumberLiteralNode",
                                                                          :value     1},
                                                            :trueBranch  {:__class__  "UziBlockNode",
                                                                          :statements [{:__class__   "UziConditionalNode",
                                                                                        :condition   {:__class__ "UziNumberLiteralNode",
                                                                                                      :value     0},
                                                                                        :trueBranch  {:__class__  "UziBlockNode",
                                                                                                      :statements [{:__class__ "UziCallNode",
                                                                                                                    :selector  "delayS",
                                                                                                                    :arguments [{:__class__ "Association",
                                                                                                                                 :key       nil,
                                                                                                                                 :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                                             :value     1000}}]}]},
                                                                                        :falseBranch {:__class__  "UziBlockNode",
                                                                                                      :statements []}}]},
                                                            :falseBranch {:__class__  "UziBlockNode",
                                                                          :statements [{:__class__ "UziCallNode",
                                                                                        :selector  "delayMs",
                                                                                        :arguments [{:__class__ "Association",
                                                                                                     :key       nil,
                                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                 :value     1000}}]}]}}]}}],
                    :primitives []}
          actual (parse src)
          ] (is (equivalent? expected actual)))

    ))

(deftest control-structures-part-II
  (testing "A task with a do while, do until and a yield"
    (let
      [src "task test()\n{\n\tdo{var a = 3;}\n\tuntil(1);\n\tdo{\n\t\tvar a= 4;\n\t\tyield;\n\t}while(1);\n}"
       expected {:__class__ "UziProgramNode",
                 :globals   [],
                 :imports   [],
                 :scripts   [{:__class__ "UziTaskNode",
                              :arguments [],
                              :body      {:__class__  "UziBlockNode",
                                          :statements [{:__class__ "UziDoUntilNode",
                                                        :condition {:__class__ "UziNumberLiteralNode",
                                                                    :value     1},
                                                        :negated   true,
                                                        :post      {:__class__  "UziBlockNode",
                                                                    :statements []},
                                                        :pre       {:__class__  "UziBlockNode",
                                                                    :statements [{:__class__ "UziVariableDeclarationNode",
                                                                                  :name      "a",
                                                                                  :value     {:__class__ "UziNumberLiteralNode",
                                                                                              :value     3}}]}},
                                                       {:__class__ "UziDoWhileNode",
                                                        :condition {:__class__ "UziNumberLiteralNode",
                                                                    :value     1},
                                                        :negated   false,
                                                        :post      {:__class__  "UziBlockNode",
                                                                    :statements []},
                                                        :pre       {:__class__  "UziBlockNode",
                                                                    :statements [{:__class__ "UziVariableDeclarationNode",
                                                                                  :name      "a",
                                                                                  :value     {:__class__ "UziNumberLiteralNode",
                                                                                              :value     4}},
                                                                                 {:__class__ "UziYieldNode",
                                                                                  }]}}]},
                              :name      "test",
                              :state     "once"}]}

       actual (parse src)] (is (equivalent? expected actual)))))

(deftest motor-usage
  (testing "Two tasks that operate a servo and a DC. This has some imports"
    (let [src "import motor from 'DCMotor.uzi' {\n\tenablePin = D10;\n\tforwardPin = D9;\n\treversePin = D8;\n}\n\ntask servo() {\n\tforever {\n\t\tsetServoDegrees(D3, 90);\n\t\tdelayMs(1000);\n\t\tsetServoDegrees(D3, 0);\n\t\tdelayMs(1000);\n\t}\n}\n\ntask default1() running 20/m {\n\tmotor.forward(speed: 1);\n\tdelayMs(1000);\n\tmotor.brake();\n\tdelayMs(1000);\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [{:__class__           "UziImportNode",
                                  :alias               "motor",
                                  :path                "DCMotor.uzi",
                                  :initializationBlock {:__class__  "UziBlockNode",
                                                        :statements [{:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "enablePin"},
                                                                      :right     {:__class__ "UziPinLiteralNode",
                                                                                  :type      "D",
                                                                                  :number    10}},
                                                                     {:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "forwardPin"},
                                                                      :right     {:__class__ "UziPinLiteralNode",
                                                                                  :type      "D",
                                                                                  :number    9}},
                                                                     {:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "reversePin"},
                                                                      :right     {:__class__ "UziPinLiteralNode",
                                                                                  :type      "D",
                                                                                  :number    8}}]}}],
                    :globals    [],
                    :scripts    [{:__class__ "UziTaskNode",
                                  :name      "servo",
                                  :arguments [],
                                  :state     "once",
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziForeverNode",
                                                            :body      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziCallNode",
                                                                                      :selector  "setServoDegrees",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :type      "D",
                                                                                                               :number    3}},
                                                                                                  {:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziNumberLiteralNode",
                                                                                                               :value     90}}]},
                                                                                     {:__class__ "UziCallNode",
                                                                                      :selector  "delayMs",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziNumberLiteralNode",
                                                                                                               :value     1000}}]},
                                                                                     {:__class__ "UziCallNode",
                                                                                      :selector  "setServoDegrees",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :type      "D",
                                                                                                               :number    3}},
                                                                                                  {:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziNumberLiteralNode",
                                                                                                               :value     0}}]},
                                                                                     {:__class__ "UziCallNode",
                                                                                      :selector  "delayMs",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziNumberLiteralNode",
                                                                                                               :value     1000}}]}]}}]}},
                                 {:__class__   "UziTaskNode",
                                  :name        "default1",
                                  :arguments   [],
                                  :state       "running",
                                  :tickingRate {:__class__ "UziTickingRateNode",
                                                :value     20,
                                                :scale     "m"},
                                  :body        {:__class__  "UziBlockNode",
                                                :statements [{:__class__ "UziCallNode",
                                                              :selector  "motor.forward",
                                                              :arguments [{:__class__ "Association",
                                                                           :key       "speed",
                                                                           :value     {:__class__ "UziNumberLiteralNode",
                                                                                       :value     1}}]},
                                                             {:__class__ "UziCallNode",
                                                              :selector  "delayMs",
                                                              :arguments [{:__class__ "Association",
                                                                           :key       nil,
                                                                           :value     {:__class__ "UziNumberLiteralNode",
                                                                                       :value     1000}}]},
                                                             {:__class__ "UziCallNode",
                                                              :selector  "motor.brake",
                                                              :arguments []},
                                                             {:__class__ "UziCallNode",
                                                              :selector  "delayMs",
                                                              :arguments [{:__class__ "Association",
                                                                           :key       nil,
                                                                           :value     {:__class__ "UziNumberLiteralNode",
                                                                                       :value     1000}}]}]}}],
                    :primitives []}
          actual (parse src)] (is (equivalent? expected actual)))))

(deftest sonar-and-button
  (testing "Two tasks where one handles a button to start and stop the sonar one"
    (let [src "import sonar from 'Sonar.uzi' {\n\ttrigPin = D11;\n\techoPin = D12;\n\tmaxDistance = 200;\n\tstart reading;\n}\nimport buttons from 'Buttons.uzi' {\n\tdebounceMs = 50;\n}\n\nvar variable1;\n\ntask sonar() stopped 1/h {\n\twrite(D13, sonar.distance_cm());\n}\n\ntask button() running 1/s {\n\tif variable1 {\n\t\tbuttons.waitForRelease(D7);\n\t\tvariable1 = !variable1;\n\t\tstart sonar;\n\t} else {\n\t\tstop sonar;\n\t}\n}"
          expected {:__class__  "UziProgramNode",
                    :imports    [{:__class__           "UziImportNode",
                                  :alias               "sonar",
                                  :path                "Sonar.uzi",
                                  :initializationBlock {:__class__  "UziBlockNode",
                                                        :statements [{:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "trigPin"},
                                                                      :right     {:__class__ "UziPinLiteralNode",
                                                                                  :type      "D",
                                                                                  :number    11}},
                                                                     {:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "echoPin"},
                                                                      :right     {:__class__ "UziPinLiteralNode",
                                                                                  :type      "D",
                                                                                  :number    12}},
                                                                     {:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "maxDistance"},
                                                                      :right     {:__class__ "UziNumberLiteralNode",
                                                                                  :value     200}},
                                                                     {:__class__ "UziScriptStartNode",
                                                                      :scripts   ["reading"]}]}},
                                 {:__class__           "UziImportNode",
                                  :alias               "buttons",
                                  :path                "Buttons.uzi",
                                  :initializationBlock {:__class__  "UziBlockNode",
                                                        :statements [{:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "debounceMs"},
                                                                      :right     {:__class__ "UziNumberLiteralNode",
                                                                                  :value     50}}]}}],
                    :globals    [{:__class__ "UziVariableDeclarationNode",
                                  :name      "variable1"}],
                    :scripts    [{:__class__   "UziTaskNode",
                                  :name        "sonar",
                                  :arguments   [],
                                  :state       "stopped",
                                  :tickingRate {:__class__ "UziTickingRateNode",
                                                :value     1,
                                                :scale     "h"},
                                  :body        {:__class__  "UziBlockNode",
                                                :statements [{:__class__ "UziCallNode",
                                                              :selector  "write",
                                                              :arguments [{:__class__ "Association",
                                                                           :key       nil,
                                                                           :value     {:__class__ "UziPinLiteralNode",
                                                                                       :type      "D",
                                                                                       :number    13}},
                                                                          {:__class__ "Association",
                                                                           :key       nil,
                                                                           :value     {:__class__ "UziCallNode",
                                                                                       :selector  "sonar.distance_cm",
                                                                                       :arguments []}}]}]}},
                                 {:__class__   "UziTaskNode",
                                  :name        "button",
                                  :arguments   [],
                                  :state       "running",
                                  :tickingRate {:__class__ "UziTickingRateNode",
                                                :value     1,
                                                :scale     "s"},
                                  :body        {:__class__  "UziBlockNode",
                                                :statements [{:__class__   "UziConditionalNode",
                                                              :condition   {:__class__ "UziVariableNode",
                                                                            :name      "variable1"},
                                                              :trueBranch  {:__class__  "UziBlockNode",
                                                                            :statements [{:__class__ "UziCallNode",
                                                                                          :selector  "buttons.waitForRelease",
                                                                                          :arguments [{:__class__ "Association",
                                                                                                       :key       nil,
                                                                                                       :value     {:__class__ "UziPinLiteralNode",
                                                                                                                   :type      "D",
                                                                                                                   :number    7}}]},
                                                                                         {:__class__ "UziAssignmentNode",
                                                                                          :left      {:__class__ "UziVariableNode",
                                                                                                      :name      "variable1"},
                                                                                          :right     {:__class__ "UziCallNode",
                                                                                                      :selector  "!",
                                                                                                      :arguments [{:__class__ "Association",
                                                                                                                   :key       nil,
                                                                                                                   :value     {:__class__ "UziVariableNode",
                                                                                                                               :name      "variable1"}}]}},
                                                                                         {:__class__ "UziScriptStartNode",
                                                                                          :scripts   ["sonar"]}]},
                                                              :falseBranch {:__class__  "UziBlockNode",
                                                                            :statements [{:__class__ "UziScriptStopNode",
                                                                                          :scripts   ["sonar"]}]}}]}}],
                    :primitives []}
          actual (parse src)] (is (equivalent? expected actual)))))

(deftest primitive-definition
  (testing "Creating a few primitives"
    (let [src "\nprim add;\nprim ~= : notEquals;\n\ntask test() {\n\tvar a = add(3, 4);\n\tvar b = 3 ~= 4;\n}"
          expected {:__class__  "UziProgramNode",
                    :globals    [],
                    :imports    [],
                    :primitives [{:__class__ "UziPrimitiveDeclarationNode",
                                  :alias     "add",
                                  :name      "add"},
                                 {:__class__ "UziPrimitiveDeclarationNode",
                                  :alias     "~=",
                                  :name      "notEquals"}],
                    :scripts    [{:__class__ "UziTaskNode",
                                  :arguments [],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziVariableDeclarationNode",
                                                            :name      "a",
                                                            :value     {:__class__     "UziCallNode",
                                                                        :arguments     [{:__class__ "Association",
                                                                                         :key       nil,
                                                                                         :value     {:__class__ "UziNumberLiteralNode",
                                                                                                     :value     3}},
                                                                                        {:__class__ "Association",
                                                                                         :key       nil,
                                                                                         :value     {:__class__ "UziNumberLiteralNode",
                                                                                                     :value     4}}],
                                                                        :selector      "add"}},
                                                           {:__class__ "UziVariableDeclarationNode",
                                                            :name      "b",
                                                            :value     {:__class__     "UziCallNode",
                                                                        :arguments     [{:__class__ "Association",
                                                                                         :key       nil,
                                                                                         :value     {:__class__ "UziNumberLiteralNode",
                                                                                                     :value     3}},
                                                                                        {:__class__ "Association",
                                                                                         :key       nil,
                                                                                         :value     {:__class__ "UziNumberLiteralNode",
                                                                                                     :value     4}}],
                                                                        :selector      "~="}}]},
                                  :name      "test",
                                  :state     "once"}]}
          actual (parse src)] (is (equivalent? expected actual)))))

(deftest uzi-syntax
  (testing "A code that explores all the syntax of UZI. This is based on the file syntax.uzi"
    (let [src "\"This is just an example of code that uses all the available syntax\nin the language.\"\n\"I wrote it to help me create a syntax highlighter for the \"\"Ace\"\" editor\"\n\nimport foo from 'DCMotor.uzi';\nimport bar from 'Sonar.uzi' {\n  trigPin = 100;\n  echoPin = 200;\n  start reading;\n  stop reading;\n  pause reading;\n  resume reading;\n}\n\nvar a = 10;\nvar b = 0.5;\nvar c;\n\ntask blink13() running 2/s { toggle(D13); }\ntask blink12() running 1/s { toggle(D12); }\n\ntask setup() {\n    if a { turnOn(D11); }\n    else { turnOff(D11); }\n}\n\nfunc fact(n) {\n    if n == 0 { return 1; }\n    return n * fact(n - 1);\n}\n\nproc foo_bar_baz(a, b, c) {\n    var d = a * b + c;\n    repeat d { toggle(A2); }\n    forever {\n        start blink13, blink12;\n        stop blink13;\n        yield;\n        pause blink12, blink13;\n        resume blink12; yield;\n        return;\n    }\n    while 1 && 0 { toggle(D10); delayMs(1000); }\n    until 0 || 0 { toggle(D10); delayMs(1000); }\n    while 1 >= 0; \"Body is optional\"\n    until 0 <= 1; \"Body is optional\"\n    do { toggle(D9); } while 1 > 0;\n    do { toggle(D8); } until 0 < 1;\n    for i = 0 to 10 by 1 {\n        toggle(A0);\n        delayMs(i * 100);\n    }\n\tvar e = foo.getSpeed();\n\tfoo.init(fact(1 * -2 + -3.5), a + b/d, 0);\n\tbar.init(trig: a, echo: b, maxDist: c);\n}\n"
          expected {:__class__  "UziProgramNode",
                    :globals    [{:__class__ "UziVariableDeclarationNode",
                                  :name      "a",
                                  :value     {:__class__ "UziNumberLiteralNode",
                                              :value     10}},
                                 {:__class__ "UziVariableDeclarationNode",
                                  :name      "b",
                                  :value     {:__class__ "UziNumberLiteralNode",
                                              :value     0.5}},
                                 {:__class__ "UziVariableDeclarationNode",
                                  :name      "c",
                                  :value     {:__class__ "UziNumberLiteralNode",
                                              :value     0}}],
                    :imports    [{:__class__           "UziImportNode",
                                  :alias               "foo",
                                  :initializationBlock {:__class__  "UziBlockNode"
                                                        :statements []},
                                  :path                "DCMotor.uzi"},
                                 {:__class__           "UziImportNode",
                                  :alias               "bar",
                                  :initializationBlock {:__class__  "UziBlockNode",
                                                        :statements [{:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "trigPin"},
                                                                      :right     {:__class__ "UziNumberLiteralNode",
                                                                                  :value     100}},
                                                                     {:__class__ "UziAssignmentNode",
                                                                      :left      {:__class__ "UziVariableNode",
                                                                                  :name      "echoPin"},
                                                                      :right     {:__class__ "UziNumberLiteralNode",
                                                                                  :value     200}},
                                                                     {:__class__ "UziScriptStartNode",
                                                                      :scripts   ["reading"]},
                                                                     {:__class__ "UziScriptStopNode",
                                                                      :scripts   ["reading"]},
                                                                     {:__class__ "UziScriptPauseNode",
                                                                      :scripts   ["reading"]},
                                                                     {:__class__ "UziScriptResumeNode",
                                                                      :scripts   ["reading"]}]},
                                  :path                "Sonar.uzi"}],
                    :primitives [],
                    :scripts    [{:__class__   "UziTaskNode",
                                  :arguments   [],
                                  :body        {:__class__  "UziBlockNode",
                                                :statements [{:__class__ "UziCallNode",
                                                              :arguments [{:__class__ "Association",
                                                                           :key       nil,
                                                                           :value     {:__class__ "UziPinLiteralNode",
                                                                                       :number    13,
                                                                                       :type      "D"}}],
                                                              :selector  "toggle"}]},
                                  :name        "blink13",
                                  :state       "running",
                                  :tickingRate {:__class__ "UziTickingRateNode",
                                                :scale     "s",
                                                :value     2}},
                                 {:__class__   "UziTaskNode",
                                  :arguments   [],
                                  :body        {:__class__  "UziBlockNode",
                                                :statements [{:__class__ "UziCallNode",
                                                              :arguments [{:__class__ "Association",
                                                                           :key       nil,
                                                                           :value     {:__class__ "UziPinLiteralNode",
                                                                                       :number    12,
                                                                                       :type      "D"}}],
                                                              :selector  "toggle"}]},
                                  :name        "blink12",
                                  :state       "running",
                                  :tickingRate {:__class__ "UziTickingRateNode",
                                                :scale     "s",
                                                :value     1}},
                                 {:__class__ "UziTaskNode",
                                  :arguments [],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__   "UziConditionalNode",
                                                            :condition   {:__class__ "UziVariableNode",
                                                                          :name      "a"},
                                                            :falseBranch {:__class__  "UziBlockNode",
                                                                          :statements [{:__class__ "UziCallNode",
                                                                                        :arguments [{:__class__ "Association",
                                                                                                     :key       nil,
                                                                                                     :value     {:__class__ "UziPinLiteralNode",
                                                                                                                 :number    11,
                                                                                                                 :type      "D"}}],
                                                                                        :selector  "turnOff"}]},
                                                            :trueBranch  {:__class__  "UziBlockNode",
                                                                          :statements [{:__class__ "UziCallNode",
                                                                                        :arguments [{:__class__ "Association",
                                                                                                     :key       nil,
                                                                                                     :value     {:__class__ "UziPinLiteralNode",
                                                                                                                 :number    11,
                                                                                                                 :type      "D"}}],
                                                                                        :selector  "turnOn"}]}}]},
                                  :name      "setup",
                                  :state     "once"},
                                 {:__class__ "UziFunctionNode",
                                  :arguments [{:__class__ "UziVariableDeclarationNode",
                                               :name      "n",
                                               :value     {:__class__ "UziNumberLiteralNode",
                                                           :value     0}}],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__   "UziConditionalNode",
                                                            :condition   {:__class__ "UziCallNode",
                                                                          :arguments [{:__class__ "Association",
                                                                                       :key       nil,
                                                                                       :value     {:__class__ "UziVariableNode",
                                                                                                   :name      "n"}},
                                                                                      {:__class__ "Association",
                                                                                       :key       nil,
                                                                                       :value     {:__class__ "UziNumberLiteralNode",
                                                                                                   :value     0}}],
                                                                          :selector  "=="},
                                                            :falseBranch {:__class__  "UziBlockNode",
                                                                          :statements []},
                                                            :trueBranch  {:__class__  "UziBlockNode",
                                                                          :statements [{:__class__ "UziReturnNode",
                                                                                        :value     {:__class__ "UziNumberLiteralNode",
                                                                                                    :value     1}}]}},
                                                           {:__class__ "UziReturnNode",
                                                            :value     {:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziVariableNode",
                                                                                                 :name      "n"}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziCallNode",
                                                                                                 :arguments [{:__class__ "Association",
                                                                                                              :key       nil,
                                                                                                              :value     {:__class__ "UziCallNode",
                                                                                                                          :arguments [{:__class__ "Association",
                                                                                                                                       :key       nil,
                                                                                                                                       :value     {:__class__ "UziVariableNode",
                                                                                                                                                   :name      "n"}},
                                                                                                                                      {:__class__ "Association",
                                                                                                                                       :key       nil,
                                                                                                                                       :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                                                   :value     1}}],
                                                                                                                          :selector  "-"}}],
                                                                                                 :selector  "fact"}}],
                                                                        :selector  "*"}}]},
                                  :name      "fact"},
                                 {:__class__ "UziProcedureNode",
                                  :arguments [{:__class__ "UziVariableDeclarationNode",
                                               :name      "a",
                                               :value     {:__class__ "UziNumberLiteralNode",
                                                           :value     0}},
                                              {:__class__ "UziVariableDeclarationNode",
                                               :name      "b",
                                               :value     {:__class__ "UziNumberLiteralNode",
                                                           :value     0}},
                                              {:__class__ "UziVariableDeclarationNode",
                                               :name      "c",
                                               :value     {:__class__ "UziNumberLiteralNode",
                                                           :value     0}}],
                                  :body      {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziVariableDeclarationNode",
                                                            :name      "d",
                                                            :value     {:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziCallNode",
                                                                                                 :arguments [{:__class__ "Association",
                                                                                                              :key       nil,
                                                                                                              :value     {:__class__ "UziVariableNode",
                                                                                                                          :name      "a"}},
                                                                                                             {:__class__ "Association",
                                                                                                              :key       nil,
                                                                                                              :value     {:__class__ "UziVariableNode",
                                                                                                                          :name      "b"}}],
                                                                                                 :selector  "*"}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziVariableNode",
                                                                                                 :name      "c"}}],
                                                                        :selector  "+"}},
                                                           {:__class__ "UziRepeatNode",
                                                            :body      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :number    2,
                                                                                                               :type      "A"}}],
                                                                                      :selector  "toggle"}]},
                                                            :times     {:__class__ "UziVariableNode",
                                                                        :name      "d"}},
                                                           {:__class__ "UziForeverNode",
                                                            :body      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziScriptStartNode",
                                                                                      :scripts   ["blink13",
                                                                                                  "blink12"]},
                                                                                     {:__class__ "UziScriptStopNode",
                                                                                      :scripts   ["blink13"]},
                                                                                     {:__class__ "UziYieldNode"},
                                                                                     {:__class__ "UziScriptPauseNode",
                                                                                      :scripts   ["blink12",
                                                                                                  "blink13"]},
                                                                                     {:__class__ "UziScriptResumeNode",
                                                                                      :scripts   ["blink12"]},
                                                                                     {:__class__ "UziYieldNode"},
                                                                                     {:__class__ "UziReturnNode",
                                                                                      :value     nil}]}},
                                                           {:__class__ "UziWhileNode",
                                                            :condition {:__class__ "UziLogicalAndNode",
                                                                        :left      {:__class__ "UziNumberLiteralNode",
                                                                                    :value     1},
                                                                        :right     {:__class__ "UziNumberLiteralNode",
                                                                                    :value     0}},
                                                            :negated   false,
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :number    10,
                                                                                                               :type      "D"}}],
                                                                                      :selector  "toggle"},
                                                                                     {:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziNumberLiteralNode",
                                                                                                               :value     1000}}],
                                                                                      :selector  "delayMs"}]},
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements []}},
                                                           {:__class__ "UziUntilNode",
                                                            :condition {:__class__ "UziLogicalOrNode",
                                                                        :left      {:__class__ "UziNumberLiteralNode",
                                                                                    :value     0},
                                                                        :right     {:__class__ "UziNumberLiteralNode",
                                                                                    :value     0}},
                                                            :negated   true,
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :number    10,
                                                                                                               :type      "D"}}],
                                                                                      :selector  "toggle"},
                                                                                     {:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziNumberLiteralNode",
                                                                                                               :value     1000}}],
                                                                                      :selector  "delayMs"}]},
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements []}},
                                                           {:__class__ "UziWhileNode",
                                                            :condition {:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     1}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     0}}],
                                                                        :selector  ">="},
                                                            :negated   false,
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements []},
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements []}},
                                                           {:__class__ "UziUntilNode",
                                                            :condition {:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     0}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     1}}],
                                                                        :selector  "<="},
                                                            :negated   true,
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements []},
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements []}},
                                                           {:__class__ "UziDoWhileNode",
                                                            :condition {:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     1}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     0}}],
                                                                        :selector  ">"},
                                                            :negated   false,
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements []},
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :number    9,
                                                                                                               :type      "D"}}],
                                                                                      :selector  "toggle"}]}},
                                                           {:__class__ "UziDoUntilNode",
                                                            :condition {:__class__ "UziCallNode",
                                                                        :arguments [{:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     0}},
                                                                                    {:__class__ "Association",
                                                                                     :key       nil,
                                                                                     :value     {:__class__ "UziNumberLiteralNode",
                                                                                                 :value     1}}],
                                                                        :selector  "<"},
                                                            :negated   true,
                                                            :post      {:__class__  "UziBlockNode",
                                                                        :statements []},
                                                            :pre       {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :number    8,
                                                                                                               :type      "D"}}],
                                                                                      :selector  "toggle"}]}},
                                                           {:__class__ "UziForNode",
                                                            :body      {:__class__  "UziBlockNode",
                                                                        :statements [{:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziPinLiteralNode",
                                                                                                               :number    0,
                                                                                                               :type      "A"}}],
                                                                                      :selector  "toggle"},
                                                                                     {:__class__ "UziCallNode",
                                                                                      :arguments [{:__class__ "Association",
                                                                                                   :key       nil,
                                                                                                   :value     {:__class__ "UziCallNode",
                                                                                                               :arguments [{:__class__ "Association",
                                                                                                                            :key       nil,
                                                                                                                            :value     {:__class__ "UziVariableNode",
                                                                                                                                        :name      "i"}},
                                                                                                                           {:__class__ "Association",
                                                                                                                            :key       nil,
                                                                                                                            :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                                        :value     100}}],
                                                                                                               :selector  "*"}}],
                                                                                      :selector  "delayMs"}]},
                                                            :counter   {:__class__ "UziVariableDeclarationNode",
                                                                        :name      "i",
                                                                        :value     {:__class__ "UziNumberLiteralNode",
                                                                                    :value     0}},
                                                            :start     {:__class__ "UziNumberLiteralNode",
                                                                        :value     0},
                                                            :step      {:__class__ "UziNumberLiteralNode",
                                                                        :value     1},
                                                            :stop      {:__class__ "UziNumberLiteralNode",
                                                                        :value     10}},
                                                           {:__class__ "UziVariableDeclarationNode",
                                                            :name      "e",
                                                            :value     {:__class__ "UziCallNode",
                                                                        :arguments [],
                                                                        :selector  "foo.getSpeed"}},
                                                           {:__class__ "UziCallNode",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziCallNode",
                                                                                     :arguments [{:__class__ "Association",
                                                                                                  :key       nil,
                                                                                                  :value     {:__class__ "UziCallNode",
                                                                                                              :arguments [{:__class__ "Association",
                                                                                                                           :key       nil,
                                                                                                                           :value     {:__class__ "UziCallNode",
                                                                                                                                       :arguments [{:__class__ "Association",
                                                                                                                                                    :key       nil,
                                                                                                                                                    :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                                                                :value     1}},
                                                                                                                                                   {:__class__ "Association",
                                                                                                                                                    :key       nil,
                                                                                                                                                    :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                                                                :value     -2}}],
                                                                                                                                       :selector  "*"}},
                                                                                                                          {:__class__ "Association",
                                                                                                                           :key       nil,
                                                                                                                           :value     {:__class__ "UziNumberLiteralNode",
                                                                                                                                       :value     -3.5}}],
                                                                                                              :selector  "+"}}],
                                                                                     :selector  "fact"}},
                                                                        {:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziCallNode",
                                                                                     :arguments [{:__class__ "Association",
                                                                                                  :key       nil,
                                                                                                  :value     {:__class__ "UziVariableNode",
                                                                                                              :name      "a"}},
                                                                                                 {:__class__ "Association",
                                                                                                  :key       nil,
                                                                                                  :value     {:__class__ "UziCallNode",
                                                                                                              :arguments [{:__class__ "Association",
                                                                                                                           :key       nil,
                                                                                                                           :value     {:__class__ "UziVariableNode",
                                                                                                                                       :name      "b"}},
                                                                                                                          {:__class__ "Association",
                                                                                                                           :key       nil,
                                                                                                                           :value     {:__class__ "UziVariableNode",
                                                                                                                                       :name      "d"}}],
                                                                                                              :selector  "/"}}],
                                                                                     :selector  "+"}},
                                                                        {:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziNumberLiteralNode",
                                                                                     :value     0}}],
                                                            :selector  "foo.init"},
                                                           {:__class__ "UziCallNode",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       "trig",
                                                                         :value     {:__class__ "UziVariableNode",
                                                                                     :name      "a"}},
                                                                        {:__class__ "Association",
                                                                         :key       "echo",
                                                                         :value     {:__class__ "UziVariableNode",
                                                                                     :name      "b"}},
                                                                        {:__class__ "Association",
                                                                         :key       "maxDist",
                                                                         :value     {:__class__ "UziVariableNode",
                                                                                     :name      "c"}}],
                                                            :selector  "bar.init"}]},
                                  :name      "foo_bar_baz"}]}
          actual (parse src)]
      (is (equivalent? expected actual)))))

(deftest spaces-1
  (let [src "task default() running 1/s {\n\ttoggle(D13 );\n}"
        expected {:__class__  "UziProgramNode",
                  :imports    [],
                  :globals    [],
                  :scripts    [{:__class__   "UziTaskNode",
                                :name        "default",
                                :arguments   [],
                                :state       "running",
                                :tickingRate {:__class__ "UziTickingRateNode",
                                              :value     1,
                                              :scale     "s"},
                                :body        {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziCallNode",
                                                            :selector  "toggle",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziPinLiteralNode",
                                                                                     :type      "D",
                                                                                     :number    13}}]}]}}],
                  :primitives []}
        actual (parse src)]
    (is (equivalent? expected actual))))

(deftest spaces-2
  (let [src "task default() running 1/s {\n\ttoggle (D13);\n}"
        expected {:__class__  "UziProgramNode",
                  :imports    [],
                  :globals    [],
                  :scripts    [{:__class__   "UziTaskNode",
                                :name        "default",
                                :arguments   [],
                                :state       "running",
                                :tickingRate {:__class__ "UziTickingRateNode",
                                              :value     1,
                                              :scale     "s"},
                                :body        {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziCallNode",
                                                            :selector  "toggle",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziPinLiteralNode",
                                                                                     :type      "D",
                                                                                     :number    13}}]}]}}],
                  :primitives []}
        actual (parse src)]
    (is (equivalent? expected actual))))

(deftest spaces-3
  (let [src "task default () running 1/s {\n\ttoggle(D13);\n}"
        expected {:__class__  "UziProgramNode",
                  :imports    [],
                  :globals    [],
                  :scripts    [{:__class__   "UziTaskNode",
                                :name        "default",
                                :arguments   [],
                                :state       "running",
                                :tickingRate {:__class__ "UziTickingRateNode",
                                              :value     1,
                                              :scale     "s"},
                                :body        {:__class__  "UziBlockNode",
                                              :statements [{:__class__ "UziCallNode",
                                                            :selector  "toggle",
                                                            :arguments [{:__class__ "Association",
                                                                         :key       nil,
                                                                         :value     {:__class__ "UziPinLiteralNode",
                                                                                     :type      "D",
                                                                                     :number    13}}]}]}}],
                  :primitives []}
        actual (parse src)]
    (is (equivalent? expected actual))))
